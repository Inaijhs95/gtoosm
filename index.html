<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>0.36の奇跡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ベースリセット */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #444;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    /* スロット台 */
    .slot-machine {
      width: 420px;
      background: #222;
      border: 6px solid #000;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
      position: relative;
      overflow: hidden;
      padding-bottom: 20px; /* 下部に少し余裕 */
    }

    /* --- 上部ディスプレイ部 --- */
    .slot-display {
      background: #111;
      padding: 10px;
      height: 100px;
      border-bottom: 3px solid #000;
      text-align: center;
      position: relative;
    }
    .slot-display h2 {
      font-size: 1.2em;
      margin-bottom: 4px;
    }
    #spinCountText {
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    #displayMessage {
      min-height: 20px;
      font-size: 0.95em;
    }

    /* 大当たりPNGは右リール上部あたりに絶対配置 */
    .win-image {
      position: absolute;
      top: 135px;   /* 画面上からの距離（調整可） */
      right: 10px;  /* 右端からの距離（調整可） */
      width: 70px;
      display: none;
      z-index: 10;  /* リールより前面に */
    }

    /* --- 本体下部：レバー＆リール+ボタンたちを横一列に --- */
    .machine-body {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 10px;
      position: relative;
    }

    /* レバーコンテナを左端に */
    .lever-container {
      width: 60px;
      height: 100px;
      position: relative;
      margin-right: 10px;
    }
    /* シルバー棒 */
    .lever-shaft {
      position: absolute;
      left: 28px;
      top: 0;
      width: 4px;
      height: 100px;
      background: linear-gradient(#bbb, #777);
      border-radius: 2px;
    }
    /* 黒い球 */
    .lever-ball {
      position: absolute;
      left: 10px;
      top: 0;
      width: 40px;
      height: 40px;
      background: radial-gradient(#222, #000);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.6) inset, 0 4px 6px rgba(0,0,0,0.8);
      user-select: none;

      /* スマホでのハイライト等を防ぐ(押し込み演出が見やすくなる) */
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none; 
      
      /* アニメーションを滑らかに */
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    /* 押し込む間だけ下がるアニメを .pressed クラスで表現 */
    .lever-ball.pressed {
      transform: translateY(40px);
    }

    /* --- リールとストップボタンを横並びで1列×3セット --- */
    .reels-stop-area {
      display: flex;
      gap: 10px;
    }
    .reel-stop {
      display: flex;
      flex-direction: column; /* 縦にリール + ボタン */
      align-items: center;
    }

    /* リール枠 */
    .reel {
      width: 60px;
      height: 80px; /* 窓の高さ */
      overflow: hidden;
      border-radius: 8px;
      background: #000;
      box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
      margin-bottom: 6px;
      position: relative;
    }
    /* リール内 */
    .numbers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: #fff; /* 全体を白背景に */
    }
    .numbers div {
      height: 30px;
      line-height: 30px;
      text-align: center;
      background: transparent; /* 個々は透明(上で白背景にしている) */
      color: #000;
      border-bottom: 1px solid #ccc;
      font-size: 1.2em;
    }

    /* ストップボタン(赤) */
    .stop-btn {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      border: 2px solid #aa0000;
      background: linear-gradient(to bottom, #ff5555, #bb0000);
      color: #fff;
      font-size: 0.8em;
      font-weight: bold;
      box-shadow: 0 0 4px rgba(0,0,0,0.8) inset, 0 3px 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }
    .stop-btn:active {
      transform: translateY(2px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
    }
    .stop-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ストップ後、その行を太字にするクラス */
    .boldNumber {
      font-weight: bold;
    }

    /* モーダルのスタイル */
    .modal {
      display: none; /* 初期状態は非表示 */
      position: fixed;
      z-index: 20; /* 他の要素より前面に表示 */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; /* 必要に応じてスクロール */
      background-color: rgba(0, 0, 0, 0.7); /* 背景を半透明に */
    }

    /* モーダルコンテンツ */
    .modal-content {
      background-color: #fff;
      color: #000;
      margin: 15% auto; /* 縦中央に配置 */
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 10px;
      text-align: center;
      position: relative;
    }

    /* 閉じるボタン */
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: #000;
    }

    /* モーダルボタン */
    .modal-content button {
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }

    #confirmRedirect {
      background-color: #28a745;
      color: #fff;
    }

    #confirmRedirect:hover {
      background-color: #218838;
    }

    #cancelRedirect {
      background-color: #dc3545;
      color: #fff;
    }

    #cancelRedirect:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>

<div class="slot-machine">
  <!-- ディスプレイ -->
  <div class="slot-display">
    <h2>スロットπの秘宝</h2>
    <div id="spinCountText"></div>
    <div id="displayMessage">なんぼでも挑戦可能！狙うはあの数字？</div>
  </div>

  <!-- 大当たり画像（右リール上部あたりに重ね表示） -->
  <img src="osm.png" alt="Win Image" class="win-image" id="winImage">

  <!-- 本体下部：レバー + (リール+ストップ)×3 -->
  <div class="machine-body">
    <!-- レバー -->
    <div class="lever-container">
      <div class="lever-shaft"></div>
      <div class="lever-ball" id="leverBall"></div>
    </div>

    <!-- リール&STOPを3セット横並び -->
    <div class="reels-stop-area">
      <!-- 1番リール -->
      <div class="reel-stop">
        <div class="reel" id="reel1">
          <div class="numbers" id="numbers1"></div>
        </div>
        <button class="stop-btn" id="stop1" disabled>STOP</button>
      </div>
      <!-- 2番リール -->
      <div class="reel-stop">
        <div class="reel" id="reel2">
          <div class="numbers" id="numbers2"></div>
        </div>
        <button class="stop-btn" id="stop2" disabled>STOP</button>
      </div>
      <!-- 3番リール -->
      <div class="reel-stop">
        <div class="reel" id="reel3">
          <div class="numbers" id="numbers3"></div>
        </div>
        <button class="stop-btn" id="stop3" disabled>STOP</button>
      </div>
    </div>
  </div>
</div>

<!-- 大当たりモーダル -->
<div id="jackpotModal" class="modal">
  <div class="modal-content">
    <span class="close-button" id="closeModal">&times;</span>
    <h2>大当たり！</h2>
    <p>おめでとうございます！LINE画面に移動しますか？</p>
    <button id="confirmRedirect">はい</button>
    <button id="cancelRedirect">プレイを続ける</button>
  </div>
</div>

<script>
  /* -------------------------------------------
      1)  指を置いた瞬間にレバーが下がり、同時にスロットを回す
      2)  指を離す(またはマウスを離す)まで押し込み状態を維持
      3)  STOP すると、リールの真ん中(約40px)に数字が止まり
         該当数字を太字に
      4)  当たり(0,3,6)ならモーダルポップアップを表示してURLへ飛ぶ
  ------------------------------------------- */

  // ----------------------------------------
  //  レバー押下演出 & スロット起動
  // ----------------------------------------
  const leverBall = document.getElementById('leverBall');

  // PCマウス用: mousedown で回転開始
  leverBall.addEventListener('mousedown', e => {
    e.preventDefault();
    handleLeverPress();
  });
  // 指を離したら押し込み解除
  leverBall.addEventListener('mouseup', e => {
    leverBall.classList.remove('pressed');
  });
  leverBall.addEventListener('mouseleave', e => {
    leverBall.classList.remove('pressed');
  });

  // スマホタッチ用: touchstart で回転開始
  leverBall.addEventListener('touchstart', e => {
    e.preventDefault();
    handleLeverPress();
  }, {passive:false});
  // 離したら押し込み解除
  leverBall.addEventListener('touchend', () => {
    leverBall.classList.remove('pressed');
  });
  leverBall.addEventListener('touchcancel', () => {
    leverBall.classList.remove('pressed');
  });

  // レバー押し込み時の処理をまとめた関数
  function handleLeverPress() {
    // レバーを下げる演出
    leverBall.classList.add('pressed');

    // スロットを回し始める
    startSlotIfNotSpinning();
  }

  // ----------------------------------------
  //   スロットの本体ロジック
  // ----------------------------------------
  const spinCountText = document.getElementById('spinCountText');
  const displayMessage = document.getElementById('displayMessage');
  const winImage = document.getElementById('winImage');

  const stopBtn1 = document.getElementById('stop1');
  const stopBtn2 = document.getElementById('stop2');
  const stopBtn3 = document.getElementById('stop3');

  const numbers1 = document.getElementById('numbers1');
  const numbers2 = document.getElementById('numbers2');
  const numbers3 = document.getElementById('numbers3');

  /* --- 回転数を localStorage で管理 --- */
  let spinCount = parseInt(localStorage.getItem('slotSpinCount') || '0', 10);
  function updateSpinCountDisplay() {
    spinCountText.textContent = `回転数：${spinCount}`;
  }
  updateSpinCountDisplay();

  /* --- 0～7 を何回か繰り返したリストを各リールに表示（DOM生成）--- */
  function fillNumbersDOM(container) {
    // 0～7 を4回繰り返して計32行など
    const repeatTimes = 4;
    const digits = [];
    for(let r=0; r<repeatTimes; r++){
      for(let n=0; n<8; n++){
        digits.push(n);
      }
    }
    container.innerHTML = '';
    digits.forEach(num => {
      const div = document.createElement('div');
      div.textContent = num;
      container.appendChild(div);
    });
  }
  fillNumbersDOM(numbers1);
  fillNumbersDOM(numbers2);
  fillNumbersDOM(numbers3);

  let isSpinning = [false, false, false];
  let reelPos = [0, 0, 0];
  let reelTimer = [null, null, null];
  const reelHeight = 30 * 8 * 4;  // 32行 * 30px = 960px
  const scrollSpeed = 60;         // px/interval

  // 抽選結果
  let finalResults = [0, 0, 0];

  // モーダル関連の要素を取得
  const jackpotModal = document.getElementById('jackpotModal');
  const closeModalButton = document.getElementById('closeModal');
  const confirmRedirectButton = document.getElementById('confirmRedirect');
  const cancelRedirectButton = document.getElementById('cancelRedirect');

  // モーダルを表示する関数
  function showJackpotModal() {
    jackpotModal.style.display = 'block';
  }

  // モーダルを閉じる関数
  function closeJackpotModal() {
    jackpotModal.style.display = 'none';
  }

  // モーダルの外側をクリックしたら閉じる
  window.addEventListener('click', function(event) {
    if (event.target == jackpotModal) {
      closeJackpotModal();
    }
  });

  // 確認ボタンをクリックしたらLINEにリダイレクト
  confirmRedirectButton.addEventListener('click', () => {
    window.location.href = "https://line.me/R/oaMessage/%40778unfqy/%E3%83%A1%E3%83%A2%E3%81%AE%E8%AC%8E%E3%80%81%E8%A7%A3%E3%81%91%E3%81%BE%E3%81%97%E3%81%9F";
  });

  // キャンセルボタンをクリックしたらモーダルを閉じる
  cancelRedirectButton.addEventListener('click', () => {
    closeJackpotModal();
  });

  // 閉じるボタンをクリックしたらモーダルを閉じる
  closeModalButton.addEventListener('click', () => {
    closeJackpotModal();
  });

  // レバーを押した瞬間に呼ばれる(もし未回転ならスタート)
  function startSlotIfNotSpinning() {
    // まだ回転中なら何もしない
    if(isSpinning.some(sp => sp)) return;

    // 回転数アップ
    spinCount++;
    localStorage.setItem('slotSpinCount', spinCount);
    updateSpinCountDisplay();

    // メッセージ等リセット
    displayMessage.textContent = "";
    winImage.style.display = "none";

    // 抽選
    // (36%で 0,3,6 / 64%でランダム)
    if(Math.random() < 0.36){
      finalResults = [0, 3, 6];
    } else {
      finalResults = [
        Math.floor(Math.random()*8),
        Math.floor(Math.random()*8),
        Math.floor(Math.random()*8),
      ];
    }

    // 3本のリールを回転開始
    for(let i=0; i<3; i++){
      startReel(i);
    }

    // STOPボタン有効
    stopBtn1.disabled = false;
    stopBtn2.disabled = false;
    stopBtn3.disabled = false;
  }

  // リール回転
  function startReel(idx) {
    isSpinning[idx] = true;
    reelPos[idx] = 0;
    const container = [numbers1, numbers2, numbers3][idx];
    // 既存のsetIntervalがあればクリア
    if(reelTimer[idx]) clearInterval(reelTimer[idx]);

    reelTimer[idx] = setInterval(() => {
      reelPos[idx] += scrollSpeed;
      // モジュロでループ
      if(reelPos[idx] > reelHeight){
        reelPos[idx] %= reelHeight;
      }
      container.style.transform = `translateY(-${reelPos[idx]}px)`;
    }, 20);
  }

  // STOPボタン
  stopBtn1.addEventListener('click', () => stopReel(0, stopBtn1));
  stopBtn2.addEventListener('click', () => stopReel(1, stopBtn2));
  stopBtn3.addEventListener('click', () => stopReel(2, stopBtn3));

  function stopReel(idx, btn){
    if(!isSpinning[idx]) return;
    clearInterval(reelTimer[idx]);
    isSpinning[idx] = false;
    btn.disabled = true;

    // 最終結果をリール中央にあわせる
    const finalVal = finalResults[idx];
    const container = [numbers1, numbers2, numbers3][idx];
    const allDivs = container.querySelectorAll('div');
    allDivs.forEach(div => div.classList.remove('boldNumber'));

    let closestDist = Infinity;
    let bestOffset = 0;
    let bestIndex = 0;

    for(let i=0; i<allDivs.length; i++){
      const num = parseInt(allDivs[i].textContent,10);
      if(num===finalVal){
        const desiredOffset = i*30 - 25; // (真ん中40px付近に行を合わせる)
        const dist = Math.abs(desiredOffset - reelPos[idx]);
        if(dist < closestDist){
          closestDist = dist;
          bestOffset = desiredOffset;
          bestIndex = i;
        }
      }
    }
    function modInRange(x, range){
      return ((x%range)+range)%range;
    }
    reelPos[idx] = modInRange(bestOffset, reelHeight);
    container.style.transform = `translateY(-${reelPos[idx]}px)`;
    allDivs[bestIndex].classList.add('boldNumber');

    // 全停止したら結果判定
    if(!isSpinning[0] && !isSpinning[1] && !isSpinning[2]){
      checkResult();
    }
  }

  function checkResult(){
    const [r1, r2, r3] = finalResults;
    if(r1===0 && r2===3 && r3===6){
      // 大当たり
      displayMessage.textContent = "036が出ました！";
      winImage.style.display = "block";
      // 回転数リセット
      spinCount=0;
      localStorage.setItem('slotSpinCount', spinCount);
      updateSpinCountDisplay();

      // モーダルを表示
      setTimeout(() => {
        showJackpotModal();
      },2000);
    } else {
      displayMessage.textContent = "なんぼでも挑戦可能！狙うはあの数字？";
    }
  }
</script>
</body>
</html>
