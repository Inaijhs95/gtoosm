<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>0.36の奇跡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ベースリセット */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #444;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    /* スロット台 */
    .slot-machine {
      width: 420px;
      background: #222;
      border: 6px solid #000;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
      position: relative;
      overflow: hidden;
      padding-bottom: 20px; /* 下部に少し余裕 */
    }

    /* --- 上部ディスプレイ部 --- */
    .slot-display {
      background: #111;
      padding: 10px;
      height: 100px;
      border-bottom: 3px solid #000;
      text-align: center;
      position: relative;
    }
    .slot-display h2 {
      font-size: 1.2em;
      margin-bottom: 4px;
    }
    #spinCountText {
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    #displayMessage {
      min-height: 20px;
      font-size: 0.95em;
    }

    /* 大当たりPNGは右リール上部あたりに絶対配置 */
    .win-image {
      position: absolute;
      top: 170px;   /* 画面上からの距離（調整可） */
      right: 15px;  /* 右端からの距離（調整可） */
      width: 70px;
      display: none;
      z-index: 10;  /* リールより前面に */
    }

    /* --- 本体下部：レバー＆リール+ボタンたちを横一列に --- */
    .machine-body {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 10px;
      position: relative;
    }

    /* レバーコンテナを左端に */
    .lever-container {
      width: 60px;
      height: 100px;
      position: relative;
      margin-right: 10px;
    }
    /* シルバー棒 */
    .lever-shaft {
      position: absolute;
      left: 28px;
      top: 0;
      width: 4px;
      height: 100px;
      background: linear-gradient(#bbb, #777);
      border-radius: 2px;
    }
    /* 黒い球 */
    .lever-ball {
      position: absolute;
      left: 10px;
      top: 0;
      width: 40px;
      height: 40px;
      background: radial-gradient(#222, #000);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.6) inset, 0 4px 6px rgba(0,0,0,0.8);
      user-select: none;

      /* スマホでのハイライト等を防ぐ(押し込み演出が見やすくなる) */
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none; 
      
      /* アニメーションを滑らかに */
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    /* 旧 :active ではなく .pressed クラスで押し込む */
    .lever-ball.pressed {
      transform: translateY(40px);
    }

    /* --- リールとストップボタンを横並びで1列×3セット --- */
    .reels-stop-area {
      display: flex;
      gap: 10px;
    }
    .reel-stop {
      display: flex;
      flex-direction: column; /* 縦にリール + ボタン */
      align-items: center;
    }

    /* リール枠 */
    .reel {
      width: 60px;
      height: 80px; /* 窓の高さ */
      overflow: hidden;
      border-radius: 8px;
      background: #000;
      box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
      margin-bottom: 6px;
      position: relative;
    }
    /* リール内 */
    .numbers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: #fff; /* 全体を白背景に */
    }
    .numbers div {
      height: 30px;
      line-height: 30px;
      text-align: center;
      background: transparent; /* 個々は透明(上で白背景にしている) */
      color: #000;
      border-bottom: 1px solid #ccc;
      font-size: 1.2em;
    }

    /* ストップボタン(赤) */
    .stop-btn {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      border: 2px solid #aa0000;
      background: linear-gradient(to bottom, #ff5555, #bb0000);
      color: #fff;
      font-size: 0.8em;
      font-weight: bold;
      box-shadow: 0 0 4px rgba(0,0,0,0.8) inset, 0 3px 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }
    .stop-btn:active {
      transform: translateY(2px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
    }
    .stop-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ストップ後、その行を太字にするクラス */
    .boldNumber {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="slot-machine">
  <!-- ディスプレイ -->
  <div class="slot-display">
    <h2>スロットゲーム</h2>
    <div id="spinCountText"></div>
    <div id="displayMessage">なんぼでも挑戦可能！狙うはあの数字？</div>
  </div>

  <!-- 大当たり画像（右リール上部あたりに重ね表示） -->
  <img src="osm.png" alt="Win Image" class="win-image" id="winImage">

  <!-- 本体下部：レバー + (リール+ストップ)×3 -->
  <div class="machine-body">
    <!-- レバー -->
    <div class="lever-container">
      <div class="lever-shaft"></div>
      <div class="lever-ball" id="leverBall"></div>
    </div>

    <!-- リール&STOPを3セット横並び -->
    <div class="reels-stop-area">
      <!-- 1番リール -->
      <div class="reel-stop">
        <div class="reel" id="reel1">
          <div class="numbers" id="numbers1"></div>
        </div>
        <button class="stop-btn" id="stop1" disabled>STOP<br>1</button>
      </div>
      <!-- 2番リール -->
      <div class="reel-stop">
        <div class="reel" id="reel2">
          <div class="numbers" id="numbers2"></div>
        </div>
        <button class="stop-btn" id="stop2" disabled>STOP<br>2</button>
      </div>
      <!-- 3番リール -->
      <div class="reel-stop">
        <div class="reel" id="reel3">
          <div class="numbers" id="numbers3"></div>
        </div>
        <button class="stop-btn" id="stop3" disabled>STOP<br>3</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* -------------------------------------------
      1)  0～7 を複数回並べた配列を生成して
          リール要素に差し込む
      2)  setInterval で高速に translateY を移動し
          目で追えないくらいのスピードを演出
      3)  STOP すると、リールの真ん中(約40px)に
          最終結果の数字が来るように微調整し、
          その行だけ太字にする
      4)  レバー押下演出は :active ではなく
          JSで .pressed を付与して確認しやすく
  ------------------------------------------- */

  /* --- レバー押し込み演出（.pressed） --- */
  const leverBall = document.getElementById('leverBall');
  // PCマウス用
  leverBall.addEventListener('mousedown', () => {
    leverBall.classList.add('pressed');
  });
  leverBall.addEventListener('mouseup', () => {
    leverBall.classList.remove('pressed');
  });
  leverBall.addEventListener('mouseleave', () => {
    leverBall.classList.remove('pressed');
  });

  // スマホタッチ用
  leverBall.addEventListener('touchstart', (e) => {
    e.preventDefault(); // iOSでのダブルタップズーム等を防ぐ
    leverBall.classList.add('pressed');
  }, {passive:false});
  leverBall.addEventListener('touchend', () => {
    leverBall.classList.remove('pressed');
  });
  leverBall.addEventListener('touchcancel', () => {
    leverBall.classList.remove('pressed');
  });

  /* --------------------------------------- */
  const spinCountText = document.getElementById('spinCountText');
  const displayMessage = document.getElementById('displayMessage');
  const winImage = document.getElementById('winImage');

  const stopBtn1 = document.getElementById('stop1');
  const stopBtn2 = document.getElementById('stop2');
  const stopBtn3 = document.getElementById('stop3');

  const numbers1 = document.getElementById('numbers1');
  const numbers2 = document.getElementById('numbers2');
  const numbers3 = document.getElementById('numbers3');

  /* --- 回転数を localStorage で管理 --- */
  let spinCount = parseInt(localStorage.getItem('slotSpinCount') || '0', 10);
  function updateSpinCountDisplay() {
    spinCountText.textContent = `回転数：${spinCount}`;
  }
  updateSpinCountDisplay();

  /* --- 0～7 を何回か繰り返したリストを各リールに表示（DOM生成）--- */
  function fillNumbersDOM(container) {
    // 0～7 を4回繰り返して計32行など
    const repeatTimes = 4;
    const digits = [];
    for(let r=0; r<repeatTimes; r++){
      for(let n=0; n<8; n++){
        digits.push(n);
      }
    }
    // DOM生成
    container.innerHTML = '';
    digits.forEach(num => {
      const div = document.createElement('div');
      div.textContent = num;
      container.appendChild(div);
    });
  }
  fillNumbersDOM(numbers1);
  fillNumbersDOM(numbers2);
  fillNumbersDOM(numbers3);

  /* --- リール回転管理用 --- */
  let isSpinning = [false, false, false];  // 各リールが回転中か
  let reelPos = [0, 0, 0];                 // translateY の現在値
  let reelTimer = [null, null, null];      // setInterval ID
  const reelHeight = 30 * 8 * 4;           // 上で 0～7を4セット = 32行, 1行30px => 960px
  // スクロール速度(px/interval)
  const scrollSpeed = 60;  // 1回のsetIntervalで何px動かすか

  // 抽選結果
  let finalResults = [0, 0, 0];

  /* --- レバーを押したとき(抽選+回転スタート) --- */
  leverBall.addEventListener('click', () => {
    // まだ回転中なら無視
    if(isSpinning.some(sp => sp)) return;

    // 回転数+1, 保存
    spinCount++;
    localStorage.setItem('slotSpinCount', spinCount);
    updateSpinCountDisplay();

    // メッセージと大当たり画像をリセット
    displayMessage.textContent = "";
    winImage.style.display = "none";

    // 抽選 (36%で(0,3,6) / 64%でランダム)
    if(Math.random() < 0.36){
      finalResults = [0, 3, 6];
    } else {
      finalResults = [
        Math.floor(Math.random()*8),
        Math.floor(Math.random()*8),
        Math.floor(Math.random()*8),
      ];
    }

    // リールを3本ともスタート
    for(let i=0; i<3; i++){
      startReel(i);
    }

    // STOPボタン有効
    stopBtn1.disabled = false;
    stopBtn2.disabled = false;
    stopBtn3.disabled = false;
  });

  /* --- リールを回す(高速スクロール) --- */
  function startReel(idx){
    isSpinning[idx] = true;
    reelPos[idx] = 0;
    const container = (idx===0)? numbers1 : (idx===1)? numbers2 : numbers3;

    // 既存のsetIntervalがあればクリア
    if(reelTimer[idx]) clearInterval(reelTimer[idx]);

    // 高速に下へ向かってスクロール(translateY)する
    reelTimer[idx] = setInterval(() => {
      reelPos[idx] += scrollSpeed;
      // 繰り返しループ(モジュロ)
      if(reelPos[idx] > reelHeight) {
        reelPos[idx] = reelPos[idx] % reelHeight;
      }
      container.style.transform = `translateY(-${reelPos[idx]}px)`;
    }, 20); // 20msごとに scrollSpeed pxずつ動かす
  }

  /* --- STOPボタン --- */
  stopBtn1.addEventListener('click', ()=> stopReel(0, stopBtn1));
  stopBtn2.addEventListener('click', ()=> stopReel(1, stopBtn2));
  stopBtn3.addEventListener('click', ()=> stopReel(2, stopBtn3));

  function stopReel(idx, btn){
    if(!isSpinning[idx]) return;
    // 回転停止
    clearInterval(reelTimer[idx]);
    isSpinning[idx] = false;
    btn.disabled = true;

    // 最終結果の数字 finalResults[idx] をリールの「中心(約40pxの位置)」にくるように
    // かつ、その数字の行を太字にする

    const finalVal = finalResults[idx];
    const container = (idx===0)? numbers1 : (idx===1)? numbers2 : numbers3;
    const allDivs = container.querySelectorAll('div');

    // まず全行の太字を解除
    allDivs.forEach(div => div.classList.remove('boldNumber'));

    let closestDist = Infinity;
    let bestOffset = 0;
    let bestIndex = 0;

    for(let i=0; i<allDivs.length; i++){
      const num = parseInt(allDivs[i].textContent, 10);
      if(num === finalVal){
        // 通常は i*30 がリール上端に来る位置
        // しかし「真ん中(40px)」に合わせるには top を "i*30 - 25px" くらい
        const desiredOffset = i*30 - 25;

        const dist = Math.abs(desiredOffset - reelPos[idx]);
        if(dist < closestDist){
          closestDist = dist;
          bestOffset = desiredOffset;
          bestIndex = i;
        }
      }
    }

    // モジュロ演算で範囲内に収める
    function modInRange(x, range){
      return ((x % range) + range) % range;
    }
    reelPos[idx] = modInRange(bestOffset, reelHeight);
    container.style.transform = `translateY(-${reelPos[idx]}px)`;

    // 太字付与
    allDivs[bestIndex].classList.add('boldNumber');

    // 全リール止まった？
    if(!isSpinning[0] && !isSpinning[1] && !isSpinning[2]){
      checkResult();
    }
  }

  /* --- 結果判定 --- */
  function checkResult(){
    const [r1, r2, r3] = finalResults;
    if(r1===0 && r2===3 && r3===6){
      // 大当たり
      displayMessage.textContent = "おみごと！まもなくLINE画面を表示します。";
      winImage.style.display = "block";
      // 回転数リセット
      spinCount = 0;
      localStorage.setItem('slotSpinCount', spinCount);
      updateSpinCountDisplay();

      // 2秒後にリンク
      setTimeout(()=>{
        window.location.href = "https://line.me/R/oaMessage/%40778unfqy/%E3%83%A1%E3%83%A2%E3%81%AE%E8%AC%8E%E3%80%81%E8%A7%A3%E3%81%91%E3%81%BE%E3%81%97%E3%81%9F";
      }, 2000);
    } else {
      // ハズレ
      displayMessage.textContent = "なんぼでも挑戦可能！狙うはあの数字？";
    }
  }
</script>
</body>
</html>
