<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スロットゲーム</title>
  <!-- スマホ対応 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ベースリセット */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #444;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    /* スロット台外枠 */
    .slot-machine {
      width: 350px;
      background: #222;
      border: 6px solid #000;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
      position: relative;
      overflow: hidden;
    }

    /* 上部ディスプレイ */
    .slot-display {
      background: #111;
      padding: 10px;
      height: 100px;
      border-bottom: 3px solid #000;
      text-align: center;
      position: relative;
    }
    .slot-display h2 {
      font-size: 1.2em;
      margin-bottom: 4px;
    }
    #spinCountText {
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    #displayMessage {
      min-height: 20px;
      font-size: 0.95em;
    }
    #winImage {
      display: none;
      width: 80px;
      margin: 5px auto 0;
    }

    /* リール全体 */
    .reels {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 15px;
      background: linear-gradient(to bottom, #555, #333);
    }

    /* 各リール */
    .reel {
      position: relative;
      width: 70px;
      height: 100px; /* リール表示枠の高さ */
      margin: 0 5px;
      overflow: hidden; /* はみ出た部分を隠す */
      border-radius: 8px;
      background: #222;
      box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
    }
    /* 流れてくる数字を配置するコンテナ */
    .reel-inner {
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
    }
    /* 数字アイテム */
    .reel-number {
      width: 100%;
      height: 40px;
      line-height: 40px;
      text-align: center;
      font-size: 1.4em;
      background: #fff;
      color: #000;
      border-bottom: 1px solid #aaa;
    }

    /* コントロール部分 */
    .controls {
      background: #222;
      padding: 15px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .control-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* レバー：シルバー棒 + 黒い球が下がるイメージ */
    .lever-container {
      width: 60px;
      height: 90px;
      position: relative;
    }
    /* シルバーの棒（固定） */
    .lever-shaft {
      position: absolute;
      left: 28px;
      top: 0;
      width: 4px;
      height: 90px;
      background: linear-gradient(#bbb, #777);
      border-radius: 2px;
    }
    /* 黒い球（押し込むイメージ） */
    .lever-ball {
      position: absolute;
      left: 10px;
      top: 0;
      width: 40px;
      height: 40px;
      background: radial-gradient(#222, #000);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.6) inset, 0 4px 6px rgba(0,0,0,0.8);
      cursor: pointer;
      transition: transform 0.2s ease;
      user-select: none;
    }
    /* 押し下げ時：ballをshaftの下へ */
    .lever-ball:active {
      transform: translateY(35px);
    }

    /* ストップボタン(赤) */
    .stop-btn {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      border: 2px solid #aa0000;
      background: linear-gradient(to bottom, #ff5555, #bb0000);
      color: #fff;
      font-size: 0.8em;
      font-weight: bold;
      box-shadow: 0 0 4px rgba(0,0,0,0.8) inset, 0 3px 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }
    .stop-btn:active {
      transform: translateY(2px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
    }
    .stop-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

  </style>
</head>
<body>

<div class="slot-machine">
  <!-- ディスプレイ部 -->
  <div class="slot-display">
    <h2>スロットゲーム</h2>
    <div id="spinCountText"></div>
    <div id="displayMessage">なんぼでも挑戦可能！狙うはあの数字？</div>
    <img src="osm.png" alt="Win Image" id="winImage">
  </div>

  <!-- リール -->
  <div class="reels">
    <div class="reel" id="reel1">
      <div class="reel-inner" id="reelInner1"></div>
    </div>
    <div class="reel" id="reel2">
      <div class="reel-inner" id="reelInner2"></div>
    </div>
    <div class="reel" id="reel3">
      <div class="reel-inner" id="reelInner3"></div>
    </div>
  </div>

  <!-- コントロール部 -->
  <div class="controls">
    <div class="control-row">
      <!-- レバー -->
      <div class="lever-container">
        <div class="lever-shaft"></div>
        <div class="lever-ball" id="leverBall"></div>
      </div>
      <!-- ストップ1 -->
      <button class="stop-btn" id="stop1" disabled>STOP<br>1</button>
    </div>
    <div class="control-row">
      <!-- ストップ2 -->
      <button class="stop-btn" id="stop2" disabled>STOP<br>2</button>
      <!-- ストップ3 -->
      <button class="stop-btn" id="stop3" disabled>STOP<br>3</button>
    </div>
  </div>
</div>

<script>
  /* --- DOM取得 --- */
  const displayMessage = document.getElementById('displayMessage');
  const spinCountText = document.getElementById('spinCountText');
  const winImage = document.getElementById('winImage');

  const leverBall = document.getElementById('leverBall');
  const stopBtn1 = document.getElementById('stop1');
  const stopBtn2 = document.getElementById('stop2');
  const stopBtn3 = document.getElementById('stop3');

  const reelInner1 = document.getElementById('reelInner1');
  const reelInner2 = document.getElementById('reelInner2');
  const reelInner3 = document.getElementById('reelInner3');

  // リールのスクロール管理用
  let reelIntervals = [null, null, null];
  let isSpinning = [false, false, false]; 
  // 最終結果(数字)を入れる
  let finalResults = [0,0,0];

  // 回転数をローカルストレージで管理
  let spinCount = parseInt(localStorage.getItem('slotSpinCount') || '0', 10);
  updateSpinCountDisplay();

  function updateSpinCountDisplay(){
    spinCountText.textContent = `回転数：${spinCount}`;
  }

  /* --- レバーを押して抽選開始 --- */
  leverBall.addEventListener('click', () => {
    // まだどこかがスピン中なら無効
    if (isSpinning.some(sp => sp)) return;

    // 回転数更新
    spinCount++;
    localStorage.setItem('slotSpinCount', spinCount);
    updateSpinCountDisplay();

    // メッセージ＆画像リセット
    displayMessage.textContent = "";
    winImage.style.display = "none";

    // 抽選(最終結果を決定)
    // 50%で 0,3,6 / 50%で ランダム
    if(Math.random() < 0.5){
      finalResults = [0,3,6];
    } else {
      finalResults = [
        Math.floor(Math.random()*8),
        Math.floor(Math.random()*8),
        Math.floor(Math.random()*8),
      ];
    }

    // リール回転スタート
    for(let i=0; i<3; i++){
      startReel(i);
    }
    stopBtn1.disabled = false;
    stopBtn2.disabled = false;
    stopBtn3.disabled = false;
  });

  /* --- リール回転開始（上→下スクロール）--- */
  function startReel(idx){
    isSpinning[idx] = true;
    const reelInner = [reelInner1, reelInner2, reelInner3][idx];

    // 既存DOMクリア
    reelInner.innerHTML = '';
    // 毎フレーム数字を追加して下方向に動かす
    reelIntervals[idx] = setInterval(() => {
      const num = Math.floor(Math.random()*8);
      const div = document.createElement('div');
      div.className = 'reel-number';
      div.textContent = num;

      // 初期位置(最上部: -40pxくらいに置く)
      div.style.position = 'absolute';
      div.style.top = '-40px';

      reelInner.appendChild(div);

      // 数字要素をアニメ風に落としていく
      const fallDuration = 800; // 下に落ちるのにかける時間(ms)
      const startTime = performance.now();

      function animate(time){
        const elapsed = time - startTime;
        const progress = elapsed / fallDuration;
        // reelの可視領域(100px)＋数字高さ(40px)=140px分下に落ちる想定
        const distance = 140 * progress;
        div.style.top = (-40 + distance) + 'px';
        if(progress < 1 && isSpinning[idx]){
          requestAnimationFrame(animate);
        } else {
          // 画面外に出たら削除
          if(div.offsetTop > 100){
            reelInner.removeChild(div);
          }
        }
      }
      requestAnimationFrame(animate);
    }, 150);
  }

  /* --- リール停止 --- */
  stopBtn1.addEventListener('click', ()=> stopReel(0, stopBtn1));
  stopBtn2.addEventListener('click', ()=> stopReel(1, stopBtn2));
  stopBtn3.addEventListener('click', ()=> stopReel(2, stopBtn3));

  function stopReel(idx, btn){
    if(!isSpinning[idx]) return;
    clearInterval(reelIntervals[idx]);
    isSpinning[idx] = false;
    btn.disabled = true;

    // リールのスクロールを一旦止めるために、setTimeoutで最後に数字を確定表示
    setTimeout(() => {
      const reelInner = [reelInner1, reelInner2, reelInner3][idx];
      reelInner.innerHTML = ''; 
      // 最終結果を表示
      const div = document.createElement('div');
      div.className = 'reel-number';
      div.style.position = 'static'; // 通常位置で配置
      div.style.top = '0';
      div.textContent = finalResults[idx];
      reelInner.appendChild(div);

      // 全リール止まったか判定
      if(isSpinning.every(sp => !sp)){
        checkResult();
      }
    }, 300);
  }

  /* --- 結果判定 --- */
  function checkResult(){
    const [r1, r2, r3] = finalResults;
    // もし最終結果が 0,3,6 なら100%大当たり
    if(r1===0 && r2===3 && r3===6){
      showJackpot();
    } else {
      // ハズレ
      displayMessage.textContent = "なんぼでも挑戦可能！狙うはあの数字？";
    }
  }

  /* --- 大当たり演出 --- */
  function showJackpot(){
    displayMessage.textContent = "大当たり！！";
    winImage.style.display = "block";
    // 回転数リセット
    spinCount = 0;
    localStorage.setItem('slotSpinCount', spinCount);
    updateSpinCountDisplay();
  }
</script>
</body>
</html>
